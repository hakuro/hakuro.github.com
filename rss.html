<?xml version="1.0" encoding="utf-8"?>
<rss version="2.0">
    <channel>
        <title>はくろのノート</title>
        <link>http://hakuro.github.io/</link>
        <description>メモとか、文章とか書きます。</description>
        <language>en-us</language>
        <pubDate>Sat, 27 Jul 2013 00:00:00 +0900</pubDate>
        
        <item>
            <link>http://hakuro.github.io/2013/07/27/mysql_memcached_plugin.html</link>
            <guid>http://hakuro.github.io/2013/07/27/mysql_memcached_plugin.html</guid>
            <title><![CDATA[MySQL5.6のmemcached pluginを使ってみる]]></title>
            <description><![CDATA[<div class="section" id="mysql5-6memcached-plugin">
<h1>MySQL5.6のmemcached pluginを使ってみる</h1>
<p>MySQL5.6からはInnoDBにmemcachedのプロトコルでアクセスできるmemcached pluginが追加されています。</p>
<p>詳細は以下のリファレンスマニュアルが詳しいのですが、イメージ的にはSQLのレイヤを介さずに直接ストレージエンジンとやりとりする形です。
SQLのパースや実行計画の作成が必要ない分、速くなるという感じですね。</p>
<p><a class="reference external" href="http://dev.mysql.com/doc/refman/5.6/en/innodb-memcached.html">MySQL 5.6 Reference Manual 14.2.9. InnoDB Integration with memcached</a></p>
<div class="section" id="id1">
<h2>セットアップ</h2>
<div class="section" id="mysql">
<h3>MySQLのインストール</h3>
<p>まずはMySQL5.6をScientific Linux 6.4にインストールしてみました。</p>
<p>CentOSでもおおむね一緒だと思います。</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>mkdir mysql5.6 <span class="o">&amp;&amp;</span> <span class="nb">cd </span>mysql5.6
<span class="nv">$ </span>wget http://ftp.jaist.ac.jp/pub/mysql/Downloads/MySQL-5.6/MySQL-<span class="o">{</span>client,server,devel,shared,shared-compad<span class="o">}</span>-5.6.12-2.el6.x86_64.rpm
<span class="nv">$ </span>sudo yum install MySQL-<span class="o">{</span>client,server,devel,shared-compat<span class="o">}</span>-5.6.12-2.el6.x86_64.rpm
<span class="nv">$ </span>sudo yum install MySQL-shared-5.6.12-2.el6.x86_64.rpm
</pre></div>
</div>
<p>先にshared-compatをインストールすると依存関係を壊さずにMySQLのアップグレードができます。</p>
</div>
<div class="section" id="id2">
<h3>起動と初期設定</h3>
<p>インストールが完了したらMySQLを起動して、ひとまずrootでログインです。
初期パスワードは「/root/.mysql_secret」に書かれているので確認します。</p>
<p>初期パスワードを変更しないとなにもできないので、rootのパスワードを更新します。
ちなみにPASSWORD関数を使わないで更新しようとすると注意されます。</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>sudo service mysql start
<span class="nv">$ </span>sudo cat /root/.mysql_secret
<span class="nv">$ </span>mysql -uroot -p
mysql&gt; SET PASSWORD FOR root@localhost<span class="o">=</span>PASSWORD<span class="o">(</span><span class="s1">'your password'</span><span class="o">)</span>;
mysql&gt; <span class="nb">exit</span>
Bye
</pre></div>
</div>
<p>インストール時に「mysql_secure_installation」を実行しておけと言われるので、実行しておきます。</p>
<p>以下の順番で対話的に聞かれますので、Yかnを入力します。</p>
<ol class="arabic simple">
<li>rootのパスワードを変更するか？</li>
<li>anonymousユーザを削除するか？</li>
<li>リモートからのrootユーザのログインを許可するか？</li>
<li>testデータベースを削除するか？</li>
<li>権限テーブルを再読み込みするか？</li>
</ol>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>mysql_secure_installation
</pre></div>
</div>
<div class="highlight-text"><div class="highlight"><pre>NOTE: RUNNING ALL PARTS OF THIS SCRIPT IS RECOMMENDED FOR ALL MySQL SERVERS IN PRODUCTION USE!  PLEASE READ EACH STEP CAREFULLY!

In order to log into MySQL to secure it, we'll need the current password for the root user.  If you've just installed MySQL, and you haven't set the root password yet, the password will be blank, so you should just press enter here.

Enter current password for root (enter for none):
OK, successfully used password, moving on...

Setting the root password ensures that nobody can log into the MySQL root user without the proper authorisation.

You already have a root password set, so you can safely answer 'n'.

Change the root password? [Y/n] n
... skipping.

By default, a MySQL installation has an anonymous user, allowing anyone to log into MySQL without having to have a user account created for them.  This is intended only for testing, and to make the installation go a bit smoother.  You should remove them before moving into a production environment.

Remove anonymous users? [Y/n] Y
... Success!

Normally, root should only be allowed to connect from 'localhost'.  This ensures that someone cannot guess at the root password from the network.

Disallow root login remotely? [Y/n] Y
... Success!

By default, MySQL comes with a database named 'test' that anyone can access.  This is also intended only for testing, and should be removed before moving into a production environment.

Remove test database and access to it? [Y/n] n
... skipping.

Reloading the privilege tables will ensure that all changes made so far will take effect immediately.

Reload privilege tables now? [Y/n] Y
... Success!

All done!  If you've completed all of the above steps, your MySQL installation should now be secure.

Thanks for using MySQL!

Cleaning up...
</pre></div>
</div>
</div>
<div class="section" id="memcached-plugin">
<h3>memcached pluginの設定</h3>
<p>memcached pluginを有効にするには管理用のテーブルの作成とデーモンプラグインのインストールが必要です。</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>mysql -uroot -p &lt; /usr/share/mysql/innodb_memcached_config.sql
<span class="nv">$ </span>mysql -uroot -p
mysql&gt; install plugin daemon_memcached soname <span class="s2">&quot;libmemcached.so&quot;</span>;
mysql&gt; show plugins;
mysql&gt; <span class="nb">exit</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="id3">
<h2>動作確認</h2>
<div class="section" id="telnet">
<h3>telnetで接続</h3>
<p>telnetで接続して確認してみようとしましたが、Connection refused。
デフォルトのポートは11211です。</p>
<p>そもそも、ポートが開いていないようなので、iptablesに設定を追加し、再起動。</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>telnet 127.0.0.1 11211
Trying 127.0.0.1...
telnet: connect to address 127.0.0.1: Connection refused

<span class="nv">$ </span>sudo netstat -tap | grep memcache

<span class="nv">$ </span>sudo <span class="nb">echo</span> <span class="s2">&quot;-A INPUT -m state --state NEW -m tcp -p tcp --dport 11211 -j ACCEPT&quot;</span> &gt;&gt; /etc/sysconfig/iptables
<span class="nv">$ </span>sudo <span class="nb">echo</span> <span class="s2">&quot;COMMIT&quot;</span> &gt;&gt; /etc/sysconfig/iptables
<span class="nv">$ </span>sudo service iptables restart
<span class="nv">$ </span>sudo service mysql restart
</pre></div>
</div>
<p>まだ接続できないので、今度はselinuxを疑いました。
selinuxを一時的に無効にして、再起動。</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>sudo setenforce 0
<span class="nv">$ </span>sudo service mysql restart
<span class="nv">$ </span>sudo netstat -tap | grep memcache
tcp        0      0 *:memcache       *:*                LISTEN      18612/mysqld

<span class="nv">$ </span>telnet 127.0.0.1 11211
Trying 127.0.0.1...
Connected to 127.0.0.1.
Escape character is <span class="s1">'^]'</span>.
get all
END
quit
Connection closed by foreign host.
</pre></div>
</div>
<p>今度は接続に成功しました。</p>
<p>selinuxの設定を戻して、memcachedを許可する設定を追加します。</p>
</div>
</div>
</div>]]></description>
             <pubDate>Sat, 27 Jul 2013 00:00:00 +0900</pubDate>
        </item>
    
    </channel>
</rss>